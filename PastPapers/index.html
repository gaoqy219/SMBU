<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>考试真题检索系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <style>
        .module {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
        }
        .module:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background: #2563eb;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            border: none;
            transition: background 0.2s;
        }
        .btn-primary:hover:not(:disabled) {
            background: #1d4ed8;
        }
        .alert {
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        .alert-success {
            background: #ecfdf5;
            color: #059669;
            border: 1px solid #d1fae5;
        }
        .alert-error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fee2e2;
        }
        .hidden {
            display: none;
        }
        .file-list {
            margin-top: 1rem;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }
        .file-card {
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 1rem;
            transition: all 0.2s ease;
        }
        .file-card:hover {
            border-color: #2563eb;
            background: #f8fafc;
        }
        .file-card h3 {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: #1e40af;
        }
        .file-card p {
            font-size: 0.9rem;
            color: #64748b;
            margin-bottom: 0.8rem;
        }
    </style>
</head>
<body class="max-w-6xl mx-auto px-4 py-8 bg-gray-50">
    <header class="text-center mb-10">
        <h1 class="text-3xl font-bold text-gray-800">考试真题检索系统</h1>
        <p class="text-gray-600 mt-2">检索考试真题，点击直接练习</p>
    </header>

    <div class="module">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">1. 筛选试题条件</h2>
        <div class="alert alert-error hidden" id="fileAlert"></div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div>
                <label for="timeFilter" class="block mb-2 font-medium text-gray-700">考试时间</label>
                <select id="timeFilter" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="all">全部时间</option>
                </select>
            </div>
            <div>
                <label for="classFilter" class="block mb-2 font-medium text-gray-700">班级类型</label>
                <select id="classFilter" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="all">全部类型</option>
                </select>
            </div>
            <div>
                <label for="courseFilter" class="block mb-2 font-medium text-gray-700">考试课程</label>
                <select id="courseFilter" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="all">全部课程</option>
                </select>
            </div>
            <div>
                <label for="typeFilter" class="block mb-2 font-medium text-gray-700">考试类型</label>
                <select id="typeFilter" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="all">全部类型</option>
                </select>
            </div>
        </div>

        <div class="alert alert-success hidden" id="countAlert"></div>
        <div class="file-list" id="fileListContainer">
            <div class="col-span-full text-center py-12 text-gray-500">
                <i class="fa fa-spinner fa-spin fa-2x mb-3"></i>
                <p>正在加载试题文件...</p>
            </div>
        </div>
    </div>

    <footer class="text-center mt-12 text-gray-600">
        <p class="text-sm">版权所有 © 2025 ChingyuKao。保留追究侵权行为的权利。</p>
    </footer>

    <script>
        const config = {
            github: {
                username: "gaoqy219",
                repo: "SMBU",
                branch: "main",
                folder: "PastPapers", 
                pagesBase: "https://gaoqy219.github.io" 
            },
            fileParseRule: {
                separator: "+",
                fields: ["time", "classType", "course", "examType"]
            }
        };
        const elements = {
            timeFilter: document.getElementById("timeFilter"),
            classFilter: document.getElementById("classFilter"),
            courseFilter: document.getElementById("courseFilter"),
            typeFilter: document.getElementById("typeFilter"),
            fileAlert: document.getElementById("fileAlert"),
            countAlert: document.getElementById("countAlert"),
            fileListContainer: document.getElementById("fileListContainer")
        };

        let examData = [];
        document.addEventListener('DOMContentLoaded', () => {
            loadExamFiles();
            bindFilterEvents();
        });

        function bindFilterEvents() {
            [elements.timeFilter, elements.classFilter, elements.courseFilter, elements.typeFilter].forEach(filter => {
                filter.addEventListener('change', filterExamFiles);
            });
        }
        async function loadExamFiles() {
            try {
                const apiUrl = `https://api.github.com/repos/${config.github.username}/${config.github.repo}/contents/${config.github.folder}?ref=${config.github.branch}`;
                const response = await fetch(apiUrl);

                if (response.status === 404) throw new Error(`未找到${config.github.folder}目录`);
                if (!response.ok) throw new Error(`文件加载失败 (${response.status})`);

                const files = await response.json();
                const examFiles = files.filter(file => 
                    file.name.endsWith(".html") && 
                    file.type === "file" && 
                    !file.name.toLowerCase().includes("index.html") // 屏蔽index.html
                );

                if (examFiles.length === 0) {
                    showAlert(elements.fileAlert, "未找到任何试题HTML文件", "error");
                    renderEmptyState();
                    return;
                }

                examData = parseExamFilenames(examFiles);
                initFilterOptions();
                renderExamFiles(examData);
                elements.countAlert.textContent = `共找到 ${examData.length} 个试题文件`;
                elements.countAlert.classList.remove("hidden");

            } catch (err) {
                showAlert(elements.fileAlert, `加载失败：${err.message}`, "error");
                renderEmptyState("加载失败，请稍后重试");
            }
        }

        function parseExamFilenames(files) {
            return files.map(file => {
                const nameWithoutExt = file.name.replace(".html", "");
                const parts = nameWithoutExt.split(config.fileParseRule.separator);
                const parsed = {
                    filename: file.name,
                    url: `${config.github.pagesBase}/${config.github.repo}/${config.github.folder}/${file.name}`,
                    rawName: file.name
                };

                config.fileParseRule.fields.forEach((field, index) => {
                    parsed[field] = parts[index] || "未知";
                });
                if (parsed.time && /^\d{8}$/.test(parsed.time)) {
                    parsed.formattedTime = `${parsed.time.slice(0,4)}-${parsed.time.slice(4,6)}-${parsed.time.slice(6,8)}`;
                } else {
                    parsed.formattedTime = parsed.time;
                }

                return parsed;
            });
        }
        function initFilterOptions() {
            const times = [...new Set(examData.map(item => item.time))].sort().reverse();
            const classTypes = [...new Set(examData.map(item => item.classType))].sort();
            const courses = [...new Set(examData.map(item => item.course))].sort();
            const examTypes = [...new Set(examData.map(item => item.examType))].sort();

            times.forEach(time => {
                const option = document.createElement("option");
                option.value = time;
                option.textContent = examData.find(item => item.time === time).formattedTime;
                elements.timeFilter.appendChild(option);
            });

            classTypes.forEach(type => {
                const option = document.createElement("option");
                option.value = type;
                option.textContent = type;
                elements.classFilter.appendChild(option);
            });

            courses.forEach(course => {
                const option = document.createElement("option");
                option.value = course;
                option.textContent = course;
                elements.courseFilter.appendChild(option);
            });

            examTypes.forEach(type => {
                const option = document.createElement("option");
                option.value = type;
                option.textContent = type;
                elements.typeFilter.appendChild(option);
            });
        }
        function filterExamFiles() {
            const selectedTime = elements.timeFilter.value;
            const selectedClass = elements.classFilter.value;
            const selectedCourse = elements.courseFilter.value;
            const selectedType = elements.typeFilter.value;

            const filtered = examData.filter(item => {
                const timeMatch = selectedTime === "all" || item.time === selectedTime;
                const classMatch = selectedClass === "all" || item.classType === selectedClass;
                const courseMatch = selectedCourse === "all" || item.course === selectedCourse;
                const typeMatch = selectedType === "all" || item.examType === selectedType;
                return timeMatch && classMatch && courseMatch && typeMatch;
            });

            elements.countAlert.textContent = `共找到 ${filtered.length} 个匹配试题文件`;

            if (filtered.length === 0) {
                renderEmptyState("未找到匹配的试题文件");
                return;
            }

            renderExamFiles(filtered);
        }
        function renderExamFiles(data) {
            elements.fileListContainer.innerHTML = "";

            data.forEach(item => {
                const fileCard = document.createElement("div");
                fileCard.className = "file-card";
                fileCard.innerHTML = `
                    <h3 class="font-medium hover:text-blue-600 transition">
                        <a href="${item.url}" target="_blank" rel="noopener noreferrer">${item.course}</a>
                    </h3>
                    <p><span class="font-semibold">班级：</span>${item.classType}</p>
                    <p><span class="font-semibold">考试类型：</span>${item.examType}</p>
                    <p><span class="font-semibold">考试时间：</span>${item.formattedTime}</p>
                    <button onclick="window.open('${item.url}', '_blank')" class="btn-primary w-full">
                        打开试题
                    </button>
                `;
                elements.fileListContainer.appendChild(fileCard);
            });
        }

        function renderEmptyState(text = "暂无试题文件") {
            elements.fileListContainer.innerHTML = `
                <div class="col-span-full text-center py-12 text-gray-500">
                    <i class="fa fa-search fa-2x mb-3 opacity-30"></i>
                    <p>${text}</p>
                </div>
            `;
        }

        function showAlert(element, message, type) {
            element.textContent = message;
            element.classList.remove("hidden");
            element.classList.add(`alert-${type}`);
            setTimeout(() => element.classList.add("hidden"), 3000);
        }
    </script>
</body>
</html>
